<?xml version='1.1' encoding='UTF-8'?>
<flow-definition plugin="workflow-job@2.40">
  <actions>
    <org.jenkinsci.plugins.pipeline.modeldefinition.actions.DeclarativeJobAction plugin="pipeline-model-definition@1.8.4"/>
    <org.jenkinsci.plugins.pipeline.modeldefinition.actions.DeclarativeJobPropertyTrackerAction plugin="pipeline-model-definition@1.8.4">
      <jobProperties/>
      <triggers/>
      <parameters/>
      <options/>
    </org.jenkinsci.plugins.pipeline.modeldefinition.actions.DeclarativeJobPropertyTrackerAction>
  </actions>
  <description>Reproducible Builds AOSP build for device with legacy tooling via Docker.</description>
  <keepDependencies>false</keepDependencies>
  <properties>
    <org.jenkinsci.plugins.workflow.job.properties.DisableConcurrentBuildsJobProperty/>
    <hudson.model.ParametersDefinitionProperty>
      <parameterDefinitions>
        <hudson.model.StringParameterDefinition>
          <name>AOSP_REF</name>
          <description>Branch or Tag in AOSP, refer to https://source.android.com/setup/start/build-numbers#source-code-tags-and-builds</description>
          <defaultValue>android-5.1.1_r37</defaultValue>
          <trim>false</trim>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>BUILD_ID</name>
          <description>version of AOSP, corresponds to a tag, refer to https://source.android.com/setup/start/build-numbers#source-code-tags-and-builds</description>
          <defaultValue>LMY49J</defaultValue>
          <trim>false</trim>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>DEVICE_CODENAME</name>
          <description>Internal code name for device, see https://source.android.com/setup/build/running#booting-into-fastboot-mode for details.</description>
          <defaultValue>manta</defaultValue>
          <trim>false</trim>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>DEVICE_CODENAME_FACTORY_IMAGE</name>
          <description>Alternative internal code name for device, see https://developers.google.com/android/images for details.</description>
          <defaultValue>mantaray</defaultValue>
          <trim>false</trim>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>GOOGLE_BUILD_TARGET</name>
          <description>Google build target as choosen in lunch (consist of &lt;TARGET_PRODUCT&gt;-&lt;TARGET_BUILD_VARIANT&gt;</description>
          <defaultValue>manta-user</defaultValue>
          <trim>false</trim>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>RB_BUILD_TARGET</name>
          <description>Our build target as choosen in lunch (consist of &lt;TARGET_PRODUCT&gt;-&lt;TARGET_BUILD_VARIANT&gt;</description>
          <defaultValue>aosp_manta-user</defaultValue>
          <trim>false</trim>
        </hudson.model.StringParameterDefinition>
      </parameterDefinitions>
    </hudson.model.ParametersDefinitionProperty>
  </properties>
  <definition class="org.jenkinsci.plugins.workflow.cps.CpsFlowDefinition" plugin="workflow-cps@2.92">
    <script>/*
Copyright 2020 Manuel PÃ¶ll

Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
pipeline {
    agent none

    environment {
        RB_AOSP_BASE=&quot;/home/dev/aosp&quot;

        GOOGLE_BUILD_ENV=&quot;Google&quot;
        RB_BUILD_ENV=&quot;Ubuntu14.04&quot;
        RB_BUILD_ENV_DOCKER=&quot;docker-${RB_BUILD_ENV}&quot;

        DIFF_DIR=&quot;${AOSP_REF}_${GOOGLE_BUILD_TARGET}_${GOOGLE_BUILD_ENV}__${AOSP_REF}_${RB_BUILD_TARGET}_${RB_BUILD_ENV_DOCKER}&quot;
        DIFF_PATH=&quot;${RB_AOSP_BASE}/diff/${DIFF_DIR}&quot;

        CONTAINER_NAME_BUILD=&quot;${DIFF_DIR}--build&quot;
        CONTAINER_NAME_ANALYSIS=&quot;${DIFF_DIR}--analysis&quot;
    }

    stages {
        stage(&apos;Build&apos;) {
            agent {
                docker {
                    image &apos;mobilesec/rb-aosp-build-legacy:latest&apos;
                    args &quot;&quot;&quot; --device &quot;/dev/fuse&quot; --cap-add &quot;SYS_ADMIN&quot; --security-opt &quot;apparmor:unconfined&quot; \
                        --name &quot;$CONTAINER_NAME_BUILD&quot; \
                        --mount &quot;type=bind,source=${RB_AOSP_BASE}/src,target=${RB_AOSP_BASE}/src&quot; \
                        --mount &quot;type=bind,source=${RB_AOSP_BASE}/build,target=${RB_AOSP_BASE}/build&quot; \
                        --mount &quot;type=bind,source=/boot,target=/boot&quot; \
                        --mount &quot;type=bind,source=/lib/modules,target=/lib/modules&quot; \
                    &quot;&quot;&quot;
                }
            }
            steps {
                sh &quot;( cd \&quot;${RB_AOSP_BASE}/src/.repo/repo\&quot; &amp;&amp; git checkout \&quot;v1.13.9.4\&quot; )&quot;
                sh &quot;/scripts/build-device/10_fetch-extract-factory-images.sh \&quot;${AOSP_REF}\&quot; \&quot;${BUILD_ID}\&quot; \&quot;${DEVICE_CODENAME}\&quot; \&quot;${DEVICE_CODENAME_FACTORY_IMAGE}\&quot;&quot;
                sh &quot;/scripts/build-device/11_clone-src-device.sh \&quot;${AOSP_REF}\&quot;&quot;
                sh &quot;/scripts/build-device/12_fetch-extract-vendor.sh \&quot;${BUILD_ID}\&quot; \&quot;${DEVICE_CODENAME}\&quot;&quot;
                sh &quot;/scripts/build-device/13_build-device.sh \&quot;${AOSP_REF}\&quot; \&quot;${RB_BUILD_TARGET}\&quot; \&quot;${GOOGLE_BUILD_TARGET}\&quot;&quot;
                sh &quot;/scripts/analysis/18_build-tools.sh&quot;
                sh &quot;( cd \&quot;${RB_AOSP_BASE}/src/.repo/repo\&quot; &amp;&amp; git checkout \&quot;default\&quot; )&quot;
            }
        }
        stage(&apos;Analysis&apos;) {
            agent {
                docker {
                    image &apos;mobilesec/rb-aosp-analysis:latest&apos;
                    args &quot;&quot;&quot; --device &quot;/dev/fuse&quot; --cap-add &quot;SYS_ADMIN&quot; --security-opt &quot;apparmor:unconfined&quot; \
                        --name &quot;$CONTAINER_NAME_ANALYSIS&quot; \
                        --mount &quot;type=bind,source=${RB_AOSP_BASE}/build/${AOSP_REF}/${GOOGLE_BUILD_TARGET},target=${RB_AOSP_BASE}/build/${AOSP_REF}/${GOOGLE_BUILD_TARGET}&quot; \
                        --mount &quot;type=bind,source=${RB_AOSP_BASE}/build/${AOSP_REF}/${RB_BUILD_TARGET},target=${RB_AOSP_BASE}/build/${AOSP_REF}/${RB_BUILD_TARGET}&quot; \
                        --mount &quot;type=bind,source=${RB_AOSP_BASE}/src,target=${RB_AOSP_BASE}/src&quot; \
                        --mount &quot;type=bind,source=${RB_AOSP_BASE}/diff,target=${RB_AOSP_BASE}/diff&quot; \
                        --mount &quot;type=bind,source=/boot,target=/boot&quot; \
                        --mount &quot;type=bind,source=/lib/modules,target=/lib/modules&quot;
                    &quot;&quot;&quot;
                }
            }
            steps {
                sh &quot;/scripts/analysis/19_preprocess-imgs.sh \&quot;${AOSP_REF}\&quot; \&quot;${GOOGLE_BUILD_TARGET}\&quot; \&quot;${RB_BUILD_TARGET}\&quot; \&quot;${RB_BUILD_ENV}\&quot;&quot;
                sh &quot;&quot;&quot;
                    &quot;/scripts/analysis/20_diffoscope-files.sh&quot; \
                        &quot;${RB_AOSP_BASE}/build/${AOSP_REF}/${GOOGLE_BUILD_TARGET}/${GOOGLE_BUILD_ENV}&quot; \
                        &quot;${RB_AOSP_BASE}/build/${AOSP_REF}/${RB_BUILD_TARGET}/${RB_BUILD_ENV}&quot; \
                        &quot;${DIFF_PATH}&quot;
                &quot;&quot;&quot;
                sh &quot;/scripts/analysis/21_generate-diffstat.sh \&quot;${DIFF_PATH}\&quot; \&quot;device\&quot;&quot;
                sh &quot;/scripts/analysis/22_generate-metrics.sh \&quot;${DIFF_PATH}\&quot; \&quot;device\&quot;&quot;
                sh &quot;/scripts/analysis/23_generate-visualization.sh \&quot;${DIFF_PATH}\&quot;&quot;
            }
        }
    }
}
</script>
    <sandbox>true</sandbox>
  </definition>
  <triggers/>
  <disabled>false</disabled>
</flow-definition>